<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}æˆ‘çš„è®°å½•æœ¬{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; }
        .navbar-brand { font-weight: bold; }
        .card { border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .main-content { min-height: 80vh; }
        .delete-btn { color: red; cursor: pointer; text-decoration: none; }
        .record-meta { font-size: 0.85em; color: #6c757d; }
        /* æ–°å¢æ ·å¼ */
        .record-item-content {
            flex-grow: 1; /* å æ®æ‰€æœ‰å¯ç”¨ç©ºé—´ */
            word-break: break-word; /* å…è®¸åœ¨å•è¯å†…æ¢è¡Œï¼Œé˜²æ­¢é•¿å•è¯æº¢å‡º */
            margin-right: 1rem; /* ä¸æŒ‰é’®ä¹‹é—´ä¿æŒä¸€äº›é—´è· */
            min-width: 0; /* å…³é”®ä¿®å¤: å…è®¸ flex item æ”¶ç¼©ï¼Œé˜²æ­¢å†…å®¹æº¢å‡ºæ—¶æ¨èµ°æ—è¾¹çš„å…ƒç´  */
        }
        /* æ–°å¢å¤´åƒå®¹å™¨æ ·å¼ */
        .avatar-container {
            width: 120px;
            height: 120px;
            border: 2px dashed #ccc;
            border-radius: 50%;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* ç¡®ä¿å›¾ç‰‡ä¸ä¼šæº¢å‡ºåœ†å½¢è¾¹æ¡† */
            background-color: #f8f9fa;
        }
        .category-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .category-card:hover { transform: translateY(-5px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .category-card a::after { content: ""; position: absolute; top: 0; right: 0; bottom: 0; left: 0; }
    </style>
    {% block head_script %}{% endblock %}
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand mb-0 h1" href="/">ğŸ“ æˆ‘çš„è®°å½•æœ¬</a>
            <div id="user-nav-info" class="d-none text-white d-flex align-items-center">
                <!-- **ä¿®æ”¹**: å°†ä¸ªäººä¸­å¿ƒé“¾æ¥æ”¹ä¸ºæŒ‰é’®æ ·å¼ -->
                <a href="/profile" class="btn btn-sm btn-outline-light me-3">ä¸ªäººä¸­å¿ƒ</a>
                <img id="user-avatar" src="" class="rounded-circle" width="30" height="30" alt="avatar">
                <span id="username-display" class="ms-2"></span>
                <a href="/logout" class="btn btn-sm btn-outline-light ms-3">ç™»å‡º</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12 main-content">
                {% block content %}
                <!-- åˆ†ç±»å¯¼èˆªå¡ç‰‡ -->
                <div class="row row-cols-1 row-cols-md-2 g-4">
                    <div class="col">
                        <div class="card h-100 text-center category-card">
                            <a href="/people" class="stretched-link"></a>
                            <div class="card-body">
                                <h5 class="card-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ äººå‘˜ç®¡ç†</h5>
                                <p class="card-text text-muted">æ·»åŠ æˆ–åˆ é™¤å®¶åº­æˆå‘˜</p>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card h-100 text-center category-card">
                            <a href="/medicine" class="stretched-link"></a>
                            <div class="card-body">
                                <h5 class="card-title">ğŸ’Š è¯å“è®°å½•</h5>
                                <p class="card-text text-muted">ç®¡ç†å®¶åº­æˆå‘˜çš„ç”¨è¯æƒ…å†µ</p>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card h-100 text-center category-card">
                            <a href="/clothes" class="stretched-link"></a>
                            <div class="card-body">
                                <h5 class="card-title">ğŸ‘• è¡£æœæ¸…å•</h5>
                                <p class="card-text text-muted">æ•´ç†æ¯ä¸ªäººçš„è¡£ç‰©</p>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card h-100 text-center category-card">
                            <a href="/shopping" class="stretched-link"></a>
                            <div class="card-body">
                                <h5 class="card-title">ğŸ›’ è´­ç‰©æ¸…å•</h5>
                                <p class="card-text text-muted">è®°å½•éœ€è¦è´­ä¹°çš„ç‰©å“</p>
                            </div>
                        </div>
                    </div>
                    <!-- æ–°å¢ï¼šäº¤æµç¤¾åŒºå¡ç‰‡ -->
                    <div class="col">
                        <div class="card h-100 text-center category-card">
                            <a href="/communicate" class="stretched-link"></a>
                            <div class="card-body">
                                <h5 class="card-title">ğŸ’¬ äº¤æµç¤¾åŒº</h5>
                                <p class="card-text text-muted">åˆ†äº«åŠ¨æ€ï¼Œäº’åŠ¨äº¤æµ</p>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- é€šç”¨è®°å½• -->
                <div class="card mt-4">
                    <div class="card-body">
                        <h5 class="card-title">é€šç”¨è®°å½•</h5>
                        <p class="card-text">è¿™é‡Œå¯ä»¥è®°å½•é€šç”¨çš„äº‹é¡¹ï¼Œæ¯”å¦‚å®¶åº­ä¼šè®®ã€è´­ç‰©æ¸…å•ç­‰ã€‚</p>
                    </div>
                </div>
                {% endblock %}
            </div>
        </div>

        <!-- é€šç”¨è®°å½• -->
        <!-- **ä¿®å¤**: ç§»é™¤è¿™é‡Œå¤šä½™çš„å¡ç‰‡å†…å®¹ï¼Œå®ƒåº”è¯¥åœ¨ index.html ä¸­ -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å…¨å±€è„šæœ¬ï¼Œå¤„ç†ç”¨æˆ·è®¤è¯å’Œå¯¼èˆªæ 
        document.addEventListener('DOMContentLoaded', async function() {
            const isAuthPage = ['/login', '/register'].includes(window.location.pathname);

            if (isAuthPage) {
                // å¦‚æœåœ¨ç™»å½•/æ³¨å†Œé¡µï¼Œä¸éœ€è¦æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯ï¼Œç›´æ¥è¿”å›
                return;
            }

            try {
                const response = await fetch('/api/user/current');
                if (!response.ok) {
                    // å¦‚æœè·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼ˆä¾‹å¦‚sessionè¿‡æœŸï¼‰ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
                    window.location.href = '/login';
                    return;
                }
                const user = await response.json();
                
                // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                const userNav = document.getElementById('user-nav-info');
                document.getElementById('username-display').textContent = `æ¬¢è¿, ${user.username}`;
                document.getElementById('user-avatar').src = user.avatar || 'https://via.placeholder.com/30'; // é»˜è®¤å¤´åƒ
                userNav.classList.remove('d-none');

            } catch (error) {
                console.error('Authentication check failed', error);
                window.location.href = '/login';
            }
        });
    </script>
    {% block body_script %}{% endblock %}

    <!-- æ–°å¢ï¼šå›¾ç‰‡æŸ¥çœ‹å™¨æ¨¡æ€æ¡† -->
    <div class="modal fade" id="imageViewerModal" tabindex="-1" aria-labelledby="imageViewerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageViewerModalLabel">æŸ¥çœ‹å›¾ç‰‡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="image-viewer-src" src="" class="img-fluid" alt="Enlarged image">
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ–°å¢ï¼šæ‰“å¼€å›¾ç‰‡æŸ¥çœ‹å™¨çš„å…¨å±€å‡½æ•°
        function showImageModal(imageUrl) {
            const imageViewer = document.getElementById('image-viewer-src');
            imageViewer.src = imageUrl;
            const modal = new bootstrap.Modal(document.getElementById('imageViewerModal'));
            modal.show();
        }
    </script>
</body>
</html>