<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}æˆ‘çš„è®°å½•æœ¬{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; }
        .navbar-brand { font-weight: bold; }
        .card { border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .main-content { min-height: 80vh; }
        .delete-btn { color: red; cursor: pointer; text-decoration: none; }
        .record-meta { font-size: 0.85em; color: #6c757d; }
        .category-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .category-card:hover { transform: translateY(-5px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .category-card a::after { content: ""; position: absolute; top: 0; right: 0; bottom: 0; left: 0; }
    </style>
    {% block head_script %}{% endblock %}
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand mb-0 h1" href="/">ğŸ“ æˆ‘çš„è®°å½•æœ¬</a>
            <div id="user-nav-info" class="d-none text-white d-flex align-items-center">
                <!-- **æ–°å¢**: ä¸ªäººä¸­å¿ƒé“¾æ¥ -->
                <a href="/profile" class="text-white text-decoration-none me-3">ä¸ªäººä¸­å¿ƒ</a>
                <img id="user-avatar" src="" class="rounded-circle" width="30" height="30" alt="avatar">
                <span id="username-display" class="ms-2"></span>
                <a href="/logout" class="btn btn-sm btn-outline-light ms-3">ç™»å‡º</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12 main-content">
                {% block content %}{% endblock %}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å…¨å±€è„šæœ¬ï¼Œå¤„ç†ç”¨æˆ·è®¤è¯å’Œå¯¼èˆªæ 
        document.addEventListener('DOMContentLoaded', async function() {
            const isAuthPage = ['/login', '/register'].includes(window.location.pathname);

            if (isAuthPage) {
                // å¦‚æœåœ¨ç™»å½•/æ³¨å†Œé¡µï¼Œä¸éœ€è¦æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯ï¼Œç›´æ¥è¿”å›
                return;
            }

            try {
                const response = await fetch('/api/user/current');
                if (!response.ok) {
                    // å¦‚æœè·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼ˆä¾‹å¦‚sessionè¿‡æœŸï¼‰ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
                    window.location.href = '/login';
                    return;
                }
                const user = await response.json();
                
                // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                const userNav = document.getElementById('user-nav-info');
                document.getElementById('username-display').textContent = `æ¬¢è¿, ${user.username}`;
                document.getElementById('user-avatar').src = user.avatar || 'https://via.placeholder.com/30'; // é»˜è®¤å¤´åƒ
                userNav.classList.remove('d-none');

            } catch (error) {
                console.error('Authentication check failed', error);
                window.location.href = '/login';
            }
        });
    </script>
    {% block body_script %}{% endblock %}
</body>
</html>