{% extends "base.html" %}

{% block title %}æˆ‘çš„è®°å½•æœ¬ - ä¸»é¡µ{% endblock %}

{% block content %}
<!-- åˆ†ç±»å¯¼èˆªå¡ç‰‡ -->
<div class="row row-cols-1 row-cols-md-2 g-4">
    <div class="col">
        <div class="card h-100 text-center category-card">
            <a href="/people" class="stretched-link"></a>
            <div class="card-body">
                <h5 class="card-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ äººå‘˜ç®¡ç†</h5>
                <p class="card-text text-muted">æ·»åŠ æˆ–åˆ é™¤å®¶åº­æˆå‘˜</p>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100 text-center category-card">
            <a href="/medicine" class="stretched-link"></a>
            <div class="card-body">
                <h5 class="card-title">ğŸ’Š è¯å“è®°å½•</h5>
                <p class="card-text text-muted">ç®¡ç†å®¶åº­æˆå‘˜çš„ç”¨è¯æƒ…å†µ</p>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100 text-center category-card">
            <a href="/clothes" class="stretched-link"></a>
            <div class="card-body">
                <h5 class="card-title">ğŸ‘• è¡£æœæ¸…å•</h5>
                <p class="card-text text-muted">æ•´ç†æ¯ä¸ªäººçš„è¡£ç‰©</p>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100 text-center category-card">
            <a href="/shopping" class="stretched-link"></a>
            <div class="card-body">
                <h5 class="card-title">ğŸ›’ è´­ç‰©æ¸…å•</h5>
                <p class="card-text text-muted">è®°å½•éœ€è¦è´­ä¹°çš„ç‰©å“</p>
            </div>
        </div>
    </div>
</div>


<!-- é€šç”¨è®°å½• -->
<div class="card mt-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="card-title mb-0">é€šç”¨è®°å½•</h2>
            <div>
                <!-- **æ¢å¤**: æ’åºåˆ‡æ¢å¼€å…³ -->
                <div class="form-check form-switch d-inline-block me-3" title="åˆ‡æ¢æ’åºæ–¹å¼">
                    <input class="form-check-input" type="checkbox" role="switch" id="sort-toggle-switch">
                    <label class="form-check-label" for="sort-toggle-switch" id="sort-label">æŒ‰ç´§æ€¥åº¦</label>
                </div>
                <!-- è§¦å‘æ¨¡æ€æ¡†çš„æŒ‰é’® -->
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addGeneralRecordModal">
                    æ·»åŠ è®°å½•
                </button>
            </div>
        </div>
        <hr>
        <ul id="record-list" class="list-group">
            <!-- è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
        </ul>
    </div>
</div>

<!-- æ·»åŠ é€šç”¨è®°å½•çš„æ¨¡æ€æ¡† -->
<div class="modal fade" id="addGeneralRecordModal" tabindex="-1" aria-labelledby="addGeneralRecordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addGeneralRecordModalLabel">æ·»åŠ é€šç”¨è®°å½•</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-2 mb-3">
                    <div class="col-md-12">
                        <label for="record-input" class="form-label">å†…å®¹</label>
                        <input type="text" id="record-input" class="form-control" placeholder="ä¾‹å¦‚ï¼šä¹°ä¸€ä»¶æ–°è¡£æœ">
                    </div>
                    <div class="col-md-4">
                        <label for="record-date" class="form-label">æ—¥æœŸ</label>
                        <input type="date" id="record-date" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label for="record-time" class="form-label">æ—¶é—´</label>
                        <input type="time" id="record-time" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label for="record-urgency" class="form-label">ç´§æ€¥ç¨‹åº¦</label>
                        <select id="record-urgency" class="form-select">
                            <option value="ä½">ä½</option>
                            <option value="ä¸­">ä¸­</option>
                            <option value="é«˜">é«˜</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary" onclick="addRecord('general')">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_script %}
<script>
    // **æ¢å¤**: å…¨å±€å˜é‡ç”¨äºå­˜å‚¨å½“å‰æ’åºæ–¹å¼
    let currentSortBy = 'urgency';

    // æ¸²æŸ“é€šç”¨è®°å½•ï¼ŒæŒ‰å¤©åˆ†ç»„
    async function fetchAndRenderGeneralRecords() {
        // **æ¢å¤**: åœ¨è¯·æ±‚ä¸­åŠ å…¥æ’åºå‚æ•°
        const response = await fetch(`/api/records?category=general&sort_by=${currentSortBy}`);
        const records = await response.json();
        const list = document.getElementById('record-list');
        list.innerHTML = '';

        if (records.length === 0) {
            list.innerHTML = '<li class="list-group-item text-muted">æš‚æ— é€šç”¨è®°å½•ã€‚</li>';
            return;
        }

        // æŒ‰æ—¥æœŸå¯¹è®°å½•è¿›è¡Œåˆ†ç»„
        const recordsByDate = records.reduce((acc, record) => {
            const date = record.date || 'æ— æ—¥æœŸ';
            if (!acc[date]) {
                acc[date] = [];
            }
            acc[date].push(record);
            return acc;
        }, {});

        // **å…³é”®ä¿®å¤**: ä¿®æ”¹æ—¥æœŸæ’åºé€»è¾‘ä¸ºå‡åº
        const sortedDates = Object.keys(recordsByDate).sort((a, b) => {
            if (a === 'æ— æ—¥æœŸ') return -1; // "æ— æ—¥æœŸ"å§‹ç»ˆåœ¨æœ€å‰
            if (b === 'æ— æ—¥æœŸ') return 1;
            return new Date(a) - new Date(b); // æŒ‰æ—¥æœŸå‡åºæ’åˆ—
        });

        // æŒ‰æ’åºåçš„æ—¥æœŸé”®è¿›è¡Œæ¸²æŸ“
        sortedDates.forEach(date => {
            // æ·»åŠ æ—¥æœŸæ ‡é¢˜
            const dateHeader = document.createElement('li');
            dateHeader.className = 'list-group-item list-group-item-secondary fw-bold d-flex justify-content-between align-items-center';
            
            // **æ–°å¢**: ä¸ºæ—¥æœŸæ ‡é¢˜æ·»åŠ æ‰¹é‡åˆ é™¤æŒ‰é’®
            const deleteButtonHtml = date !== 'æ— æ—¥æœŸ' ? `<button class="btn btn-sm btn-outline-danger" onclick="batchDeleteByDate('${date}')">åˆ é™¤å½“å¤©</button>` : '';
            dateHeader.innerHTML = `<span>${date}</span> ${deleteButtonHtml}`;
            list.appendChild(dateHeader);

            // æ¸²æŸ“è¯¥æ—¥æœŸçš„è®°å½•
            recordsByDate[date].forEach(record => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                
                const urgencyBadge = record.urgency ? `<span class="badge bg-${record.urgency === 'é«˜' ? 'danger' : (record.urgency === 'ä¸­' ? 'warning' : 'secondary')} me-2">${record.urgency}</span>` : '';

                // æ ¹æ®æ˜¯å¦ä¸ºåŠ¨æ€æé†’æ¥ç”Ÿæˆä¸åŒçš„æŒ‰é’®
                let buttonsHtml = '';
                // **å…³é”®ä¿®å¤**: æ˜ç¡®åŒºåˆ†ä¸‰ç§æƒ…å†µ
                if (record.is_dynamic_reminder && record.original_medicine_id) {
                    // 1. è¯å“åº“å­˜å‘Šè­¦ (åªä¿ç•™â€œå·²è´­ä¹°â€å’Œâ€œåˆ é™¤â€)
                    buttonsHtml = `
                        <button class="btn btn-sm btn-success me-2" onclick="markAsPurchasedAndRefill(${record.original_medicine_id})">å·²è´­ä¹°</button>
                        <a href="#" class="delete-btn" onclick="deleteShoppingItemFromAlert(${record.original_medicine_id})">åˆ é™¤</a>
                    `;
                } else if (record.is_shopping_reminder) {
                    // 2. è´­ç‰©ä»»åŠ¡æé†’ (åªæä¾›ä¸€ä¸ªè·³è½¬é“¾æ¥)
                    buttonsHtml = `
                        <a href="/shopping" class="btn btn-sm btn-outline-info">æŸ¥çœ‹æ¸…å•</a>
                    `;
                } else {
                    // 3. æ™®é€šé€šç”¨è®°å½•
                    buttonsHtml = `
                        <a href="#" class="btn btn-sm btn-outline-primary me-2" onclick='openEditModal(${JSON.stringify(record)})'>ç¼–è¾‘</a>
                        <button class="btn btn-sm btn-outline-success me-2" onclick="markAsCompleted(${record.id})">å®Œæˆ</button>
                        <a href="#" class="delete-btn" onclick="deleteRecord(${record.id}, 'general')">åˆ é™¤</a>
                    `;
                }

                // **å¸ƒå±€ä¿®æ”¹**: è°ƒæ•´ HTML ç»“æ„ä»¥å®ç°æ–‡æœ¬æ¢è¡Œå’ŒæŒ‰é’®å¯¹é½
                li.innerHTML = `
                    <div class="record-item-content">
                        ${urgencyBadge}
                        <span>${record.content}</span>
                        <div class="record-meta">${record.time || ''}</div>
                    </div>
                    <div class="flex-shrink-0">
                        ${buttonsHtml}
                    </div>
                `;
                list.appendChild(li);
            });
        });
    }

    // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†å¹¶å¡«å……æ•°æ®
    function openEditModal(record) {
        const modal = new bootstrap.Modal(document.getElementById('addGeneralRecordModal'));
        const modalTitle = document.getElementById('addGeneralRecordModalLabel');
        const confirmButton = document.querySelector('#addGeneralRecordModal .btn-primary');

        modalTitle.textContent = 'ç¼–è¾‘é€šç”¨è®°å½•';
        document.getElementById('record-input').value = record.content;
        document.getElementById('record-date').value = record.date;
        document.getElementById('record-time').value = record.time;
        document.getElementById('record-urgency').value = record.urgency;

        confirmButton.textContent = 'ç¡®è®¤ä¿®æ”¹';
        confirmButton.onclick = () => updateRecord(record.id, 'general');
        
        modal.show();
    }

    // **æ–°å¢**: ä»ä¸»é¡µå‘Šè­¦ä¸­åˆ é™¤è´­ç‰©é¡¹çš„å‡½æ•°
    async function deleteShoppingItemFromAlert(medicineId) {
        if (!confirm('ç¡®å®šè¦ä»è´­ç‰©æ¸…å•ä¸­ç§»é™¤è¿™æ¡è¯å“çš„è´­ä¹°éœ€æ±‚å—ï¼Ÿ')) return;

        // è°ƒç”¨åç«¯çš„ /purchase æ¥å£ï¼Œå°† needs_purchase è®¾ç½®ä¸º false
        const response = await fetch(`/api/records/${medicineId}/purchase`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ needs_purchase: false })
        });

        if (response.ok) {
            // æ“ä½œæˆåŠŸåï¼Œåˆ·æ–°ä¸»é¡µçš„è®°å½•åˆ—è¡¨
            await fetchAndRenderGeneralRecords();
        } else {
            const error = await response.json();
            alert(`æ“ä½œå¤±è´¥: ${error.error}`);
        }
    }

    // é‡ç½®æ¨¡æ€æ¡†ä¸ºâ€œæ·»åŠ â€çŠ¶æ€
    document.getElementById('addGeneralRecordModal').addEventListener('hidden.bs.modal', event => {
        const modalTitle = document.getElementById('addGeneralRecordModalLabel');
        const confirmButton = document.querySelector('#addGeneralRecordModal .btn-primary');
        
        modalTitle.textContent = 'æ·»åŠ é€šç”¨è®°å½•';
        document.getElementById('record-input').value = '';
        // å¯ä»¥é€‰æ‹©é‡ç½®æ—¥æœŸå’Œæ—¶é—´
        // const now = new Date();
        // document.getElementById('record-date').value = now.toISOString().split('T')[0];
        // document.getElementById('record-time').value = now.toTimeString().split(' ')[0].substring(0, 5);

        confirmButton.textContent = 'ç¡®è®¤æ·»åŠ ';
        confirmButton.onclick = () => addRecord('general');
    });


    // é‡å†™ addRecord ä»¥ä¾¿åœ¨æ·»åŠ åå…³é—­æ¨¡æ€æ¡†å¹¶åˆ·æ–°
    async function addRecord(category) {
        const content = document.getElementById('record-input').value;
        const date = document.getElementById('record-date').value;
        const time = document.getElementById('record-time').value;
        const urgency = document.getElementById('record-urgency').value;

        if (!content) return alert('å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');

        await fetch('/api/records', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content, category, date, time, urgency })
        });
        
        document.getElementById('record-input').value = '';
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('addGeneralRecordModal'));
        modal.hide();

        fetchAndRenderGeneralRecords();
    }

    // **æ–°å¢**: æ‰¹é‡åˆ é™¤å½“å¤©çš„æ‰€æœ‰è®°å½•
    async function batchDeleteByDate(date) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤æ—¥æœŸä¸º ${date} çš„æ‰€æœ‰é€šç”¨è®°å½•å—ï¼Ÿ`)) return;

        // è·å–å½“å¤©æ‰€æœ‰è®°å½•çš„ID
        const response = await fetch(`/api/records?category=general&status=pending`);
        const allRecords = await response.json();
        const idsToDelete = allRecords
            .filter(record => record.date === date && !record.is_medicine_reminder) // è¿‡æ»¤å‡ºå½“å¤©çš„ã€éè¯å“æé†’çš„è®°å½•
            .map(record => record.id);

        if (idsToDelete.length === 0) {
            alert('æ²¡æœ‰å¯åˆ é™¤çš„è®°å½•ã€‚');
            return;
        }

        // å¾ªç¯è°ƒç”¨åˆ é™¤API
        for (const id of idsToDelete) {
            // æˆ‘ä»¬ä¸ç­‰å¾…æ¯ä¸ªåˆ é™¤å®Œæˆï¼Œä»¥åŠ å¿«é€Ÿåº¦ï¼Œä½†ä¹Ÿå¯ä»¥ç”¨ Promise.all
            fetch(`/api/records/${id}`, { method: 'DELETE' });
        }

        // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´ååˆ·æ–°ï¼Œä»¥ç¡®ä¿æœåŠ¡å™¨æœ‰æ—¶é—´å¤„ç†åˆ é™¤
        setTimeout(() => {
            fetchAndRenderGeneralRecords();
        }, 500);
    }

    // æ–°å¢ï¼šå°†æ™®é€šè®°å½•æ ‡è®°ä¸ºå®Œæˆï¼ˆç§»åŠ¨åˆ°å·²å®ŒæˆçŠ¶æ€ï¼Œä½†ä¸ä¼šæ˜¾ç¤ºï¼‰
    async function markAsCompleted(recordId) {
        await fetch(`/api/records/${recordId}/status`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: 'completed' })
        });
        fetchAndRenderGeneralRecords();
    }

    // **å…³é”®ä¿®å¤**: ä¿®æ”¹è¯å“åº“å­˜è¡¥å……çš„é€»è¾‘ï¼Œä½¿å…¶æ›´åä¸º markAsPurchasedAndRefill
    async function markAsPurchasedAndRefill(medicineId) {
        if (!confirm('ç¡®è®¤å·²è´­ä¹°æ­¤è¯å“å—ï¼Ÿç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ‚¨è¡¥å……åº“å­˜ã€‚')) return;

        // ç›´æ¥è°ƒç”¨åç«¯çš„è‡ªåŠ¨è¡¥å……é€»è¾‘
        const response = await fetch(`/api/records/${medicineId}/refill`, {
            method: 'POST'
        });

        if (response.ok) {
            alert('è¯å“åº“å­˜å·²æ›´æ–°ï¼');
            fetchAndRenderGeneralRecords();
        } else {
            const error = await response.json();
            alert(`æ“ä½œå¤±è´¥: ${error.error}`);
        }
    }

    // æ–°å¢ï¼šæ›´æ–°è®°å½•
    async function updateRecord(id, category) {
        const payload = {
            content: document.getElementById('record-input').value,
            date: document.getElementById('record-date').value,
            time: document.getElementById('record-time').value,
            urgency: document.getElementById('record-urgency').value,
            category: category
        };

        if (!payload.content) return alert('å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');

        await fetch(`/api/records/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const modal = bootstrap.Modal.getInstance(document.getElementById('addGeneralRecordModal'));
        modal.hide();

        fetchAndRenderGeneralRecords();
    }
    
    // é‡å†™ deleteRecord ä»¥ä¾¿åˆ·æ–°
    async function deleteRecord(id, category) {
        if (typeof id === 'string' && id.startsWith('med_')) {
            console.log("Ignoring delete request for a medicine reminder.");
            return;
        }
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
        await fetch(`/api/records/${id}`, { method: 'DELETE' });
        fetchAndRenderGeneralRecords();
    }

    // ä¿®æ”¹: ä½¿ç”¨ DOMContentLoaded æ›¿ä»£ window.onload
    document.addEventListener('DOMContentLoaded', () => {
        // ç¡®ä¿åœ¨ base.html çš„è®¤è¯æ£€æŸ¥ä¹‹åæ‰§è¡Œ
        if (['/login', '/register'].includes(window.location.pathname)) return;

        // **æ¢å¤**: ä» localStorage åŠ è½½æ’åºè®¾ç½®
        const savedSortBy = localStorage.getItem('recordSortBy');
        if (savedSortBy) {
            currentSortBy = savedSortBy;
        }

        fetchAndRenderGeneralRecords();
        const now = new Date();
        const date = now.toISOString().split('T')[0];
        const time = now.toTimeString().split(' ')[0].substring(0, 5);
        document.getElementById('record-date').value = date;
        document.getElementById('record-time').value = time;

        // **æ¢å¤**: ä¸ºæ’åºå¼€å…³æ·»åŠ äº‹ä»¶ç›‘å¬å¹¶åˆå§‹åŒ–
        const sortSwitch = document.getElementById('sort-toggle-switch');
        const sortLabel = document.getElementById('sort-label');

        if (currentSortBy === 'time') {
            sortSwitch.checked = true;
            sortLabel.textContent = 'æŒ‰æ—¶é—´';
        } else {
            sortSwitch.checked = false;
            sortLabel.textContent = 'æŒ‰ç´§æ€¥åº¦';
        }

        sortSwitch.addEventListener('change', () => {
            if (sortSwitch.checked) {
                currentSortBy = 'time';
                sortLabel.textContent = 'æŒ‰æ—¶é—´';
            } else {
                currentSortBy = 'urgency';
                sortLabel.textContent = 'æŒ‰ç´§æ€¥åº¦';
            }
            localStorage.setItem('recordSortBy', currentSortBy);
            fetchAndRenderGeneralRecords();
        });
    });
</script>
{% endblock %}