{% extends "base.html" %}

{% block title %}æˆ‘çš„è®°å½•æœ¬ - ä¸»é¡µ{% endblock %}

{% block content %}
<!-- åˆ†ç±»å¯¼èˆªå¡ç‰‡ -->
<div class="row row-cols-1 row-cols-md-2 g-4">
    <div class="col">
        <div class="card h-100 text-center category-card">
            <a href="/people" class="stretched-link"></a>
            <div class="card-body">
                <h5 class="card-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ äººå‘˜ç®¡ç†</h5>
                <p class="card-text text-muted">æ·»åŠ æˆ–åˆ é™¤å®¶åº­æˆå‘˜</p>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100 text-center category-card">
            <a href="/medicine" class="stretched-link"></a>
            <div class="card-body">
                <h5 class="card-title">ğŸ’Š è¯å“è®°å½•</h5>
                <p class="card-text text-muted">ç®¡ç†å®¶åº­æˆå‘˜çš„ç”¨è¯æƒ…å†µ</p>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100 text-center category-card">
            <a href="/clothes" class="stretched-link"></a>
            <div class="card-body">
                <h5 class="card-title">ğŸ‘• è¡£æœæ¸…å•</h5>
                <p class="card-text text-muted">æ•´ç†æ¯ä¸ªäººçš„è¡£ç‰©</p>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100 text-center category-card">
            <a href="/shopping" class="stretched-link"></a>
            <div class="card-body">
                <h5 class="card-title">ğŸ›’ è´­ç‰©æ¸…å•</h5>
                <p class="card-text text-muted">è®°å½•éœ€è¦è´­ä¹°çš„ç‰©å“</p>
            </div>
        </div>
    </div>
</div>


<!-- é€šç”¨è®°å½• -->
<div class="card mt-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="card-title mb-0">é€šç”¨è®°å½•</h2>
            <!-- è§¦å‘æ¨¡æ€æ¡†çš„æŒ‰é’® -->
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addGeneralRecordModal">
                æ·»åŠ è®°å½•
            </button>
        </div>
        <hr>
        <ul id="record-list" class="list-group">
            <!-- è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
        </ul>
    </div>
</div>

<!-- æ·»åŠ é€šç”¨è®°å½•çš„æ¨¡æ€æ¡† -->
<div class="modal fade" id="addGeneralRecordModal" tabindex="-1" aria-labelledby="addGeneralRecordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addGeneralRecordModalLabel">æ·»åŠ é€šç”¨è®°å½•</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-2 mb-3">
                    <div class="col-md-12">
                        <label for="record-input" class="form-label">å†…å®¹</label>
                        <input type="text" id="record-input" class="form-control" placeholder="ä¾‹å¦‚ï¼šä¹°ä¸€ä»¶æ–°è¡£æœ">
                    </div>
                    <div class="col-md-4">
                        <label for="record-date" class="form-label">æ—¥æœŸ</label>
                        <input type="date" id="record-date" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label for="record-time" class="form-label">æ—¶é—´</label>
                        <input type="time" id="record-time" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label for="record-urgency" class="form-label">ç´§æ€¥ç¨‹åº¦</label>
                        <select id="record-urgency" class="form-select">
                            <option value="ä½">ä½</option>
                            <option value="ä¸­">ä¸­</option>
                            <option value="é«˜">é«˜</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary" onclick="addRecord('general')">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_script %}
<script>
    // æ¸²æŸ“é€šç”¨è®°å½•ï¼ŒæŒ‰å¤©åˆ†ç»„
    async function fetchAndRenderGeneralRecords() {
        const response = await fetch(`/api/records?category=general`);
        const records = await response.json();
        const list = document.getElementById('record-list');
        list.innerHTML = '';

        if (records.length === 0) {
            list.innerHTML = '<li class="list-group-item text-muted">æš‚æ— é€šç”¨è®°å½•ã€‚</li>';
            return;
        }

        // æŒ‰æ—¥æœŸå¯¹è®°å½•è¿›è¡Œåˆ†ç»„
        const recordsByDate = records.reduce((acc, record) => {
            const date = record.date || 'æ— æ—¥æœŸ';
            if (!acc[date]) {
                acc[date] = [];
            }
            acc[date].push(record);
            return acc;
        }, {});

        // æŒ‰æ—¥æœŸé”®ï¼ˆä»æ—§åˆ°æ–°ï¼Œå‡åºï¼‰æ’åºå¹¶æ¸²æŸ“
        Object.keys(recordsByDate).sort().forEach(date => {
            // æ·»åŠ æ—¥æœŸæ ‡é¢˜
            const dateHeader = document.createElement('li');
            dateHeader.className = 'list-group-item list-group-item-secondary fw-bold';
            dateHeader.textContent = date;
            list.appendChild(dateHeader);

            // æ¸²æŸ“è¯¥æ—¥æœŸçš„è®°å½•
            recordsByDate[date].forEach(record => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                
                const urgencyBadge = record.urgency ? `<span class="badge bg-${record.urgency === 'é«˜' ? 'danger' : (record.urgency === 'ä¸­' ? 'warning' : 'secondary')} me-2">${record.urgency}</span>` : '';

                li.innerHTML = `
                    <div>
                        ${urgencyBadge}
                        <span>${record.content}</span>
                        <div class="record-meta">${record.time || ''}</div>
                    </div>
                    <div>
                        <a href="#" class="btn btn-sm btn-outline-primary me-2" onclick='openEditModal(${JSON.stringify(record)})'>ç¼–è¾‘</a>
                        <a href="#" class="delete-btn" onclick="deleteRecord(${record.id}, 'general')">åˆ é™¤</a>
                    </div>
                `;
                list.appendChild(li);
            });
        });
    }

    // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†å¹¶å¡«å……æ•°æ®
    function openEditModal(record) {
        const modal = new bootstrap.Modal(document.getElementById('addGeneralRecordModal'));
        const modalTitle = document.getElementById('addGeneralRecordModalLabel');
        const confirmButton = document.querySelector('#addGeneralRecordModal .btn-primary');

        modalTitle.textContent = 'ç¼–è¾‘é€šç”¨è®°å½•';
        document.getElementById('record-input').value = record.content;
        document.getElementById('record-date').value = record.date;
        document.getElementById('record-time').value = record.time;
        document.getElementById('record-urgency').value = record.urgency;

        confirmButton.textContent = 'ç¡®è®¤ä¿®æ”¹';
        confirmButton.onclick = () => updateRecord(record.id, 'general');
        
        modal.show();
    }

    // é‡ç½®æ¨¡æ€æ¡†ä¸ºâ€œæ·»åŠ â€çŠ¶æ€
    document.getElementById('addGeneralRecordModal').addEventListener('hidden.bs.modal', event => {
        const modalTitle = document.getElementById('addGeneralRecordModalLabel');
        const confirmButton = document.querySelector('#addGeneralRecordModal .btn-primary');
        
        modalTitle.textContent = 'æ·»åŠ é€šç”¨è®°å½•';
        document.getElementById('record-input').value = '';
        // å¯ä»¥é€‰æ‹©é‡ç½®æ—¥æœŸå’Œæ—¶é—´
        // const now = new Date();
        // document.getElementById('record-date').value = now.toISOString().split('T')[0];
        // document.getElementById('record-time').value = now.toTimeString().split(' ')[0].substring(0, 5);

        confirmButton.textContent = 'ç¡®è®¤æ·»åŠ ';
        confirmButton.onclick = () => addRecord('general');
    });


    // é‡å†™ addRecord ä»¥ä¾¿åœ¨æ·»åŠ åå…³é—­æ¨¡æ€æ¡†å¹¶åˆ·æ–°
    async function addRecord(category) {
        const content = document.getElementById('record-input').value;
        const date = document.getElementById('record-date').value;
        const time = document.getElementById('record-time').value;
        const urgency = document.getElementById('record-urgency').value;

        if (!content) return alert('å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');

        await fetch('/api/records', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content, category, date, time, urgency })
        });
        
        document.getElementById('record-input').value = '';
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('addGeneralRecordModal'));
        modal.hide();

        fetchAndRenderGeneralRecords();
    }

    // æ–°å¢ï¼šæ›´æ–°è®°å½•
    async function updateRecord(id, category) {
        const payload = {
            content: document.getElementById('record-input').value,
            date: document.getElementById('record-date').value,
            time: document.getElementById('record-time').value,
            urgency: document.getElementById('record-urgency').value,
            category: category
        };

        if (!payload.content) return alert('å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');

        await fetch(`/api/records/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const modal = bootstrap.Modal.getInstance(document.getElementById('addGeneralRecordModal'));
        modal.hide();

        fetchAndRenderGeneralRecords();
    }
    
    // é‡å†™ deleteRecord ä»¥ä¾¿åˆ·æ–°
    async function deleteRecord(id, category) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
        await fetch(`/api/records/${id}`, { method: 'DELETE' });
        fetchAndRenderGeneralRecords();
    }

    window.onload = () => {
        fetchAndRenderGeneralRecords();
        const now = new Date();
        const date = now.toISOString().split('T')[0];
        const time = now.toTimeString().split(' ')[0].substring(0, 5);
        document.getElementById('record-date').value = date;
        document.getElementById('record-time').value = time;
    };
</script>
{% endblock %}