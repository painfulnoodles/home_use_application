{% extends "base.html" %}

{% block title %}衣服清单{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <a href="/" class="btn btn-sm btn-outline-secondary">&lt; 返回主页</a>
    <h1 class="mb-0">衣服清单</h1>
    <!-- 触发模态框的按钮 -->
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addClothModal">
        添加衣服
    </button>
</div>

<!-- 添加衣服的模态框 -->
<div class="modal fade" id="addClothModal" tabindex="-1" aria-labelledby="addClothModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addClothModalLabel">添加衣服</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="person-select" class="form-label">所属人物</label>
                    <select id="person-select" class="form-select"></select>
                </div>
                <div class="mb-3">
                    <label for="cloth-content-input" class="form-label">衣物名称</label>
                    <input type="text" id="cloth-content-input" class="form-control" placeholder="例如: 圆领T恤">
                </div>
                <div class="row g-2 mb-3">
                    <div class="col">
                        <label for="cloth-type-input" class="form-label">类型（选填）</label>
                        <input type="text" id="cloth-type-input" class="form-control" placeholder="例如: 上衣">
                    </div>
                    <div class="col">
                        <label for="cloth-color-input" class="form-label">颜色（选填）</label>
                        <input type="text" id="cloth-color-input" class="form-control" placeholder="例如: 白色">
                    </div>
                </div>
                <div class="mb-3">
                    <label for="cloth-quantity-input" class="form-label">数量（选填）</label>
                    <input type="number" id="cloth-quantity-input" class="form-control" value="1">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="addCloth()">确认添加</button>
            </div>
        </div>
    </div>
</div>


<!-- 显示列表 -->
<div id="clothes-display-area" class="mt-4">
    <!-- 按人物分类的衣物列表将在这里动态生成 -->
</div>
{% endblock %}

{% block body_script %}
<script>
    const CATEGORY = 'clothes';

    // 获取并填充人物下拉列表
    async function fetchAndPopulatePeople() {
        const response = await fetch('/api/people');
        const people = await response.json();
        const select = document.getElementById('person-select');
        select.innerHTML = '<option selected disabled>请选择人物...</option>';
        people.forEach(person => {
            const option = document.createElement('option');
            option.value = person.id;
            option.textContent = person.name;
            select.appendChild(option);
        });
    }

    // 添加新人物
    async function addPerson() {
        const nameInput = document.getElementById('person-name-input');
        const name = nameInput.value.trim();
        if (!name) return alert('人物名称不能为空！');

        const response = await fetch('/api/people', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        });

        if (response.ok) {
            nameInput.value = '';
            await fetchAndPopulatePeople();
        } else {
            const error = await response.json();
            alert(`添加失败: ${error.error}`);
        }
    }

    // 添加新衣服
    async function addCloth() {
        const payload = {
            person_id: document.getElementById('person-select').value,
            content: document.getElementById('cloth-content-input').value,
            type: document.getElementById('cloth-type-input').value,
            color: document.getElementById('cloth-color-input').value,
            quantity: document.getElementById('cloth-quantity-input').value,
            category: CATEGORY
        };

        if (!payload.person_id || !payload.content) {
            return alert('请填写衣服所属人物或者衣服名称！');
        }

        await fetch('/api/records', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        // 清空输入框
        document.getElementById('cloth-content-input').value = '';
        document.getElementById('cloth-type-input').value = '';
        document.getElementById('cloth-color-input').value = '';
        document.getElementById('cloth-quantity-input').value = '1';

        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('addClothModal'));
        modal.hide();

        await fetchAndDisplayClothes();
    }

    // 打开衣物编辑模态框
    function openEditClothModal(item) {
        const modal = new bootstrap.Modal(document.getElementById('addClothModal'));
        const modalTitle = document.getElementById('addClothModalLabel');
        const confirmButton = document.querySelector('#addClothModal .btn-primary');

        modalTitle.textContent = '编辑衣物';
        document.getElementById('person-select').value = item.person_id;
        document.getElementById('cloth-content-input').value = item.content;
        document.getElementById('cloth-type-input').value = item.type;
        document.getElementById('cloth-color-input').value = item.color;
        document.getElementById('cloth-quantity-input').value = item.quantity;

        confirmButton.textContent = '确认修改';
        confirmButton.onclick = () => updateCloth(item.id);
        
        modal.show();
    }

    // 重置模态框为“添加”状态
    document.getElementById('addClothModal').addEventListener('hidden.bs.modal', event => {
        const modalTitle = document.getElementById('addClothModalLabel');
        const confirmButton = document.querySelector('#addClothModal .btn-primary');
        
        modalTitle.textContent = '添加衣服';
        document.getElementById('cloth-content-input').value = '';
        document.getElementById('cloth-type-input').value = '';
        document.getElementById('cloth-color-input').value = '';
        document.getElementById('cloth-quantity-input').value = '1';
        
        confirmButton.textContent = '确认添加';
        confirmButton.onclick = addCloth;
    });

    // 更新衣物记录
    async function updateCloth(id) {
        const payload = {
            person_id: document.getElementById('person-select').value,
            content: document.getElementById('cloth-content-input').value,
            type: document.getElementById('cloth-type-input').value,
            color: document.getElementById('cloth-color-input').value,
            quantity: document.getElementById('cloth-quantity-input').value,
            category: CATEGORY
        };

        if (!payload.person_id || !payload.content) {
            return alert('请填写衣服所属人物或者衣服名称');
        }

        await fetch(`/api/records/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const modal = bootstrap.Modal.getInstance(document.getElementById('addClothModal'));
        modal.hide();

        await fetchAndDisplayClothes();
    }
    
    // 删除记录（通用）
    async function deleteCloth(id) {
        if (!confirm('确定要删除这件衣服吗？')) return;
        await fetch(`/api/records/${id}`, { method: 'DELETE' });
        await fetchAndDisplayClothes();
    }

    // 获取并按人物分组显示衣物
    async function fetchAndDisplayClothes() {
        const response = await fetch(`/api/records?category=${CATEGORY}`);
        const peopleWithClothes = await response.json();
        const displayArea = document.getElementById('clothes-display-area');
        displayArea.innerHTML = '';

        if (peopleWithClothes.length === 0) {
            displayArea.innerHTML = '<p class="text-muted">还没有任何衣物记录。</p>';
            return;
        }

        peopleWithClothes.forEach(person => {
            const personCard = document.createElement('div');
            personCard.className = 'card mb-3';
            
            let itemsHtml = '<ul class="list-group list-group-flush">';
            person.items.forEach(item => {
                itemsHtml += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${item.content}</strong> (${item.type}, ${item.color})
                        </div>
                        <div>
                            <span class="badge bg-secondary me-3">${item.quantity} 件/对</span>
                            <a href="#" class="btn btn-sm btn-outline-primary me-2" onclick='openEditClothModal(${JSON.stringify(item)})'>编辑</a>
                            <a href="#" class="delete-btn" onclick="deleteCloth(${item.id})">删除</a>
                        </div>
                    </li>
                `;
            });
            itemsHtml += '</ul>';

            personCard.innerHTML = `
                <div class="card-header">
                    <h5>${person.person_name}</h5>
                </div>
                ${itemsHtml}
            `;
            displayArea.appendChild(personCard);
        });
    }

    // **修改**: 页面加载时初始化
    document.addEventListener('DOMContentLoaded', async () => {
        if (['/login', '/register'].includes(window.location.pathname)) return;
        await fetchAndPopulatePeople();
        await fetchAndDisplayClothes();
    });
</script>
{% endblock %}