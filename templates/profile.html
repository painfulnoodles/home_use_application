{% extends "base.html" %}

{% block title %}个人中心{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <a href="/" class="btn btn-sm btn-outline-secondary">&lt; 返回主页</a>
    <h1 class="mb-0">个人中心</h1>
    <div></div>
</div>

<!-- 新增：头像修改区域 -->
<div class="card mb-4">
    <div class="card-body text-center">
        <img id="profile-avatar" src="" class="rounded-circle mb-3" width="120" height="120" alt="User Avatar" style="cursor: pointer;" onclick="document.getElementById('avatar-upload-input').click();">
        <h5 id="profile-username"></h5>
        <p class="text-muted">点击头像更换</p>
        <input type="file" id="avatar-upload-input" class="d-none" accept="image/*" onchange="uploadAvatar()">
    </div>
</div>

<h3 class="mb-3">已完成的记录</h3>
<div id="completed-records-list" class="list-group">
    <!-- 已完成的记录将在这里动态生成 -->
</div>

<!-- 添加/编辑感想和照片的模态框 -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">添加感想与照片</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="details-record-id">
                <div class="mb-3">
                    <label for="completion-notes" class="form-label">感想</label>
                    <textarea id="completion-notes" class="form-control" rows="4" placeholder="记录下此刻的想法..."></textarea>
                </div>
                <div class="mb-3">
                    <label for="completion-photos" class="form-label">添加照片</label>
                    <input type="file" id="completion-photos" class="form-control" multiple>
                </div>
                <div id="existing-photos-container">
                    <h6>已上传的照片:</h6>
                    <div id="existing-photos" class="d-flex flex-wrap gap-2"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="saveDetails()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 新增：危险操作区域 -->
<div class="card mt-5 border-danger">
    <div class="card-header bg-danger text-white">
        危险操作
    </div>
    <div class="card-body">
        <p class="card-text">注销账户将永久删除您的所有数据，包括个人信息、所有记录和上传的照片。此操作不可恢复。</p>
        <button class="btn btn-danger" onclick="deleteAccount()">注销我的账户</button>
    </div>
</div>
{% endblock %}

{% block body_script %}
<script>
    // 新增：获取当前用户信息并填充
    async function fetchUserInfo() {
        const response = await fetch('/api/user/current');
        const user = await response.json();
        // **关键修复**: 直接使用后端返回的路径，因为它已经是 URL 路径了
        document.getElementById('profile-avatar').src = user.avatar ? `/${user.avatar}` : 'https://via.placeholder.com/120';
        document.getElementById('profile-username').textContent = user.username;
    }

    // 新增：上传头像的函数
    async function uploadAvatar() {
        const input = document.getElementById('avatar-upload-input');
        if (input.files.length === 0) return;

        const formData = new FormData();
        formData.append('avatar', input.files[0]);

        const response = await fetch('/api/user/avatar', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const result = await response.json();
            // 更新页面上的头像
            document.getElementById('profile-avatar').src = result.avatar_url;
            // 更新导航栏的头像
            document.getElementById('user-avatar').src = result.avatar_url;
            alert('头像更新成功！');
        } else {
            const error = await response.json();
            alert(`上传失败: ${error.error}`);
        }
    }

    // 新增：注销账户的函数
    async function deleteAccount() {
        const confirmation = prompt('为确认此操作，请输入您的用户名：');
        if (confirmation === null) {
            return; // 用户取消了操作
        }

        // 从页面获取当前用户名进行比对
        const currentUsername = document.getElementById('profile-username').textContent;
        if (confirmation !== currentUsername) {
            alert('用户名不匹配，操作已取消。');
            return;
        }

        if (!confirm('最后警告：您确定要永久删除您的账户和所有数据吗？')) {
            return;
        }

        const response = await fetch('/api/user/delete', {
            method: 'DELETE'
        });

        if (response.ok) {
            alert('您的账户已成功注销。再见！');
            // 注销成功后，后端会自动登出，前端跳转到登录页
            window.location.href = '/login';
        } else {
            const error = await response.json();
            alert(`注销失败: ${error.error}`);
        }
    }

    async function fetchAndRenderCompletedRecords() {
        const response = await fetch('/api/records/completed');
        const records = await response.json();
        const listContainer = document.getElementById('completed-records-list');
        listContainer.innerHTML = '';

        if (records.length === 0) {
            listContainer.innerHTML = '<p class="text-muted text-center mt-4">还没有已完成的记录。</p>';
            return;
        }

        // **新增**: 按日期对记录进行分组
        const recordsByDate = records.reduce((acc, record) => {
            const date = record.date || '无日期';
            if (!acc[date]) {
                acc[date] = [];
            }
            acc[date].push(record);
            return acc;
        }, {});

        // 后端已按日期降序排序，所以直接获取 keys 即可
        const sortedDates = Object.keys(recordsByDate);

        // **修改**: 按天渲染记录
        sortedDates.forEach(date => {
            // 添加日期标题
            const dateHeader = document.createElement('div');
            dateHeader.className = 'list-group-item list-group-item-secondary fw-bold';
            dateHeader.textContent = date;
            listContainer.appendChild(dateHeader);

            // 渲染该日期的记录
            recordsByDate[date].forEach(record => {
                const photos = record.completion_photos ? JSON.parse(record.completion_photos) : [];
                let photosHtml = '';
                if (photos.length > 0) {
                    photosHtml = `<div class="mt-2 d-flex flex-wrap gap-2">` +
                        // **关键修改**: 增大图片尺寸
                        photos.map(p => `<img src="/${p}" class="img-thumbnail" width="500" height="500" alt="photo" style="object-fit: cover;">`).join('') +
                        `</div>`;
                }

                const item = document.createElement('div');
                item.className = 'list-group-item list-group-item-action flex-column align-items-start';
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">${record.content}</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick='openDetailsModal(${JSON.stringify(record)})'>编辑感想/照片</button>
                            <!-- **新增**: 删除按钮 -->
                            <a href="#" class="delete-btn" onclick="deleteCompletedRecord(${record.id})">删除</a>
                        </div>
                    </div>
                    <p class="mb-1">${record.completion_notes || '暂无感想'}</p>
                    ${photosHtml}
                </div>`;
                listContainer.appendChild(item);
            });
        });
    }

    function openDetailsModal(record) {
        const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
        document.getElementById('details-record-id').value = record.id;
        document.getElementById('completion-notes').value = record.completion_notes || '';
        document.getElementById('completion-photos').value = ''; // 清空文件输入

        const photosContainer = document.getElementById('existing-photos');
        photosContainer.innerHTML = '';
        const photos = record.completion_photos ? JSON.parse(record.completion_photos) : [];
        if (photos.length > 0) {
            photos.forEach(p => {
                // **关键修复**: 直接使用 p，不再添加前导斜杠
                photosContainer.innerHTML += `<img src="/${p}" class="img-thumbnail" width="60" height="60" alt="photo">`;
            });
            document.getElementById('existing-photos-container').classList.remove('d-none');
        } else {
            document.getElementById('existing-photos-container').classList.add('d-none');
        }

        modal.show();
    }

    // **新增**: 删除已完成记录的函数
    async function deleteCompletedRecord(recordId) {
        if (!confirm('确定要永久删除这条已完成的记录吗？此操作不可恢复。')) return;

        const response = await fetch(`/api/records/${recordId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            // 删除成功后，重新加载列表
            await fetchAndRenderCompletedRecords();
        } else {
            const error = await response.json();
            alert(`删除失败: ${error.error}`);
        }
    }

    async function saveDetails() {
        const recordId = document.getElementById('details-record-id').value;
        const notes = document.getElementById('completion-notes').value;
        const photosInput = document.getElementById('completion-photos');

        const formData = new FormData();
        formData.append('notes', notes);
        for (const file of photosInput.files) {
            formData.append('photos', file);
        }

        const response = await fetch(`/api/completed_records/${recordId}/details`, {
            method: 'POST',
            body: formData // 使用 FormData 时不需要设置 Content-Type header
        });

        if (response.ok) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('detailsModal'));
            modal.hide();
            await fetchAndRenderCompletedRecords();
        } else {
            const error = await response.json();
            alert(`保存失败: ${error.error}`);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (['/login', '/register'].includes(window.location.pathname)) return;
        fetchUserInfo(); // <-- 新增调用
        fetchAndRenderCompletedRecords();
    });
</script>
{% endblock %}