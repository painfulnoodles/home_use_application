{% extends "base.html" %}

{% block title %}äººå‘˜ç®¡ç†{% endblock %}

{% block head_script %}
<style>
    .details-card .list-group-item {
        background-color: #f8f9fa;
    }
    .medicine-icon {
        display: inline-block;
        width: 24px;
        height: 12px;
        border-radius: 6px;
        margin-right: 8px;
        vertical-align: middle;
        border: 1px solid rgba(0,0,0,0.2);
    }
    .medicine-icon.tablet {
        width: 16px;
        height: 16px;
        border-radius: 50%;
    }
</style>
{% endblock %}

{% block content %}
<a href="/" class="btn btn-sm btn-outline-secondary mb-3">&lt; è¿”å›ä¸»é¡µ</a>

<div class="row">
    <!-- å·¦ä¾§ï¼šäººç‰©åˆ—è¡¨ä¸æ“ä½œ -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">æ·»åŠ æ–°äººç‰©</h5>
                <div class="input-group mb-3">
                    <input type="text" id="person-name-input" class="form-control" placeholder="äººç‰©åç§°">
                    <button class="btn btn-primary" onclick="addPerson()">æ·»åŠ </button>
                </div>
                <hr>
                <h5 class="card-title">æŸ¥çœ‹äººç‰©ä¿¡æ¯</h5>
                <select id="person-select" class="form-select" onchange="showPersonDetails()">
                    <option selected disabled>è¯·é€‰æ‹©ä¸€ä¸ªäººç‰©...</option>
                </select>
            </div>
        </div>
        <div class="card mt-3">
            <div class="card-header">äººç‰©åˆ—è¡¨</div>
            <ul id="people-list" class="list-group list-group-flush">
                <!-- äººç‰©å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </ul>
        </div>
    </div>

    <!-- å³ä¾§ï¼šäººç‰©è¯¦ç»†ä¿¡æ¯ -->
    <div class="col-md-8">
        <div id="details-area" class="d-none">
            <h3 id="details-person-name"></h3>
            <hr>
            <!-- è¯å“ä¿¡æ¯ -->
            <div class="card details-card mb-3">
                <div class="card-header">ğŸ’Š è¯å“ä¿¡æ¯</div>
                <ul id="medicines-list" class="list-group list-group-flush"></ul>
            </div>
            <!-- è¡£ç‰©ä¿¡æ¯ -->
            <div class="card details-card">
                <div class="card-header">ğŸ‘• è¡£ç‰©ä¿¡æ¯</div>
                <ul id="clothes-list" class="list-group list-group-flush"></ul>
            </div>
        </div>
        <div id="details-placeholder" class="text-center text-muted mt-5">
            <p>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªäººç‰©ä»¥æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚</p>
        </div>
    </div>
</div>
{% endblock %}

{% block body_script %}
<script>
    // å¡«å……äººç‰©åˆ—è¡¨å’Œä¸‹æ‹‰èœå•
    async function populatePeopleLists() {
        const response = await fetch('/api/people');
        const people = await response.json();
        
        const list = document.getElementById('people-list');
        const select = document.getElementById('person-select');
        
        list.innerHTML = '';
        select.innerHTML = '<option selected disabled value="">è¯·é€‰æ‹©ä¸€ä¸ªäººç‰©...</option>';

        if (people.length === 0) {
            list.innerHTML = '<li class="list-group-item text-muted">æš‚æ— äººç‰©ï¼Œè¯·åœ¨å·¦ä¾§æ·»åŠ ã€‚</li>';
            return;
        }

        people.forEach(person => {
            // å¡«å……åˆ—è¡¨
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `
                <span>${person.name}</span>
                <a href="#" class="delete-btn" onclick="deletePerson(${person.id})">åˆ é™¤</a>
            `;
            list.appendChild(li);

            // å¡«å……ä¸‹æ‹‰èœå•
            const option = document.createElement('option');
            option.value = person.id;
            option.textContent = person.name;
            select.appendChild(option);
        });
    }

    // æ˜¾ç¤ºé€‰ä¸­äººç‰©çš„è¯¦ç»†ä¿¡æ¯
    async function showPersonDetails() {
        const select = document.getElementById('person-select');
        const personId = select.value;
        const personName = select.options[select.selectedIndex].text;

        if (!personId) return;

        const response = await fetch(`/api/people/${personId}/details`);
        const details = await response.json();

        document.getElementById('details-placeholder').classList.add('d-none');
        document.getElementById('details-area').classList.remove('d-none');
        document.getElementById('details-person-name').textContent = `${personName} çš„ç›¸å…³ä¿¡æ¯`;

        // æ¸²æŸ“è¯å“åˆ—è¡¨
        const medicinesList = document.getElementById('medicines-list');
        medicinesList.innerHTML = '';
        if (details.medicines.length > 0) {
            details.medicines.forEach(item => {
                const iconHtml = `<span class="medicine-icon ${item.style}" style="background-color: ${item.color};"></span>`;
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.innerHTML = `${iconHtml} <strong>${item.content}</strong> <small class="text-muted">(${item.frequency || 'æœªæŒ‡å®šé¢‘ç‡'})</small>`;
                medicinesList.appendChild(li);
            });
        } else {
            medicinesList.innerHTML = '<li class="list-group-item text-muted">æ— ç›¸å…³è¯å“è®°å½•ã€‚</li>';
        }

        // æ¸²æŸ“è¡£ç‰©åˆ—è¡¨
        const clothesList = document.getElementById('clothes-list');
        clothesList.innerHTML = '';
        if (details.clothes.length > 0) {
            details.clothes.forEach(item => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.innerHTML = `<strong>${item.content}</strong> <small class="text-muted">(${item.type}, ${item.color}) - ${item.quantity}ä»¶</small>`;
                clothesList.appendChild(li);
            });
        } else {
            clothesList.innerHTML = '<li class="list-group-item text-muted">æ— ç›¸å…³è¡£ç‰©è®°å½•ã€‚</li>';
        }
    }

    // æ·»åŠ æ–°äººç‰©
    async function addPerson() {
        const nameInput = document.getElementById('person-name-input');
        const name = nameInput.value.trim();
        if (!name) return alert('äººç‰©åç§°ä¸èƒ½ä¸ºç©ºï¼');

        const response = await fetch('/api/people', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        });

        if (response.ok) {
            nameInput.value = '';
            await populatePeopleLists();
        } else {
            const error = await response.json();
            alert(`æ·»åŠ å¤±è´¥: ${error.error}`);
        }
    }

    // åˆ é™¤äººç‰©
    async function deletePerson(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäººç‰©å—ï¼Ÿç›¸å…³çš„è¡£ç‰©å’Œè¯å“è®°å½•ä¹Ÿä¼šè¢«åˆ é™¤ï¼')) return;
        
        const response = await fetch(`/api/people/${id}`, { method: 'DELETE' });

        if (response.ok) {
            // æ¸…ç©ºè¯¦æƒ…åŒºåŸŸå¹¶é‡æ–°åŠ è½½åˆ—è¡¨
            document.getElementById('details-area').classList.add('d-none');
            document.getElementById('details-placeholder').classList.remove('d-none');
            await populatePeopleLists();
        } else {
            const error = await response.json();
            alert(`åˆ é™¤å¤±è´¥: ${error.error}`);
        }
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.onload = populatePeopleLists;
</script>
{% endblock %}