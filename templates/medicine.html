{% extends "base.html" %}

{% block title %}药品记录{% endblock %}

{% block head_script %}
<style>
    .medicine-shape {
        display: inline-block;
        width: 24px;
        height: 24px;
        margin-right: 10px;
        vertical-align: middle;
        border: 1px solid rgba(0,0,0,0.1);
        background-color: transparent; /* 默认背景透明 */
    }
    .shape-circle { /* 圆形 */
        border-radius: 50%;
    }
    .shape-oval { /* 椭圆形 */
        width: 28px;
        height: 18px;
        border-radius: 50%;
    }
    .shape-triangle { /* 三角形 */
        width: 0;
        height: 0;
        border-left: 12px solid transparent;
        border-right: 12px solid transparent;
        border-bottom: 22px solid; /* 颜色将通过内联样式设置 */
        border-top: none;
        border-radius: 0;
    }
</style>
{% endblock %}


{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <a href="/" class="btn btn-sm btn-outline-secondary">&lt; 返回主页</a>
    <h1 class="mb-0">药品记录</h1>
    <!-- 触发模态框的按钮 -->
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMedicineModal">
        添加药品
    </button>
</div>

<!-- 添加药品的模态框 (已存在) -->
<div class="modal fade" id="addMedicineModal" tabindex="-1" aria-labelledby="addMedicineModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMedicineModalLabel">添加药品</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="person-select" class="form-label">所属人物</label>
                    <select id="person-select" class="form-select"></select>
                </div>
                <div class="mb-3">
                    <label for="medicine-content-input" class="form-label">药品名称 <span class="text-danger">*</span></label>
                    <input type="text" id="medicine-content-input" class="form-control" placeholder="例如: 布洛芬">
                </div>
                <div class="row g-2 mb-3">
                    <div class="col">
                        <label for="medicine-frequency-input" class="form-label">每天次数 (选填)</label>
                        <div class="input-group">
                            <input type="number" id="medicine-frequency-input" class="form-control" placeholder="例如: 3">
                            <span class="input-group-text">次</span>
                        </div>
                    </div>
                    <div class="col">
                        <label for="medicine-dosage-input" class="form-label">每次用量 (选填)</label>
                        <div class="input-group">
                            <input type="number" id="medicine-dosage-input" class="form-control" placeholder="例如: 2">
                            <span class="input-group-text">片</span>
                        </div>
                    </div>
                </div>
                <div class="row g-2 mb-3">
                    <div class="col">
                        <label for="medicine-style-select" class="form-label">形状 (选填)</label>
                        <select id="medicine-style-select" class="form-select">
                            <option value="circle">圆形</option>
                            <option value="triangle">三角形</option>
                            <option value="oval">椭圆形</option>
                        </select>
                    </div>
                    <div class="col">
                        <label for="medicine-color-input" class="form-label">形状颜色</label>
                        <input type="color" id="medicine-color-input" class="form-control form-control-color" value="#86B7FE" title="选择颜色">
                    </div>
                </div>

                <!-- 修改：将初始数量和补充数量分开，以便独立控制 -->
                <div id="add-total-quantity-row" class="mb-3">
                    <label for="medicine-total-quantity-input" class="form-label">初始总数量（片，选填）</label>
                    <input type="number" id="medicine-total-quantity-input" class="form-control" placeholder="例如：30">
                </div>
                <div class="mb-3">
                    <label for="medicine-refill-quantity-input" class="form-label">每次补充数量（选填）</label>
                    <input type="number" id="medicine-refill-quantity-input" class="form-control" placeholder="例如：60">
                </div>
                <div class="mb-3">
                    <label for="medicine-reminder-threshold-input" class="form-label">库存提醒阈值（选填）</label>
                    <div class="input-group">
                        <input type="number" id="medicine-reminder-threshold-input" class="form-control" placeholder="默认: 5">
                        <span class="input-group-text">片</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="addMedicine()">确认添加</button>
            </div>
        </div>
    </div>
</div>

<!-- **新增**: 更新药品数量的模态框 -->
<div class="modal fade" id="refillMedicineModal" tabindex="-1" aria-labelledby="refillMedicineModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="refillMedicineModalLabel">更新药品数量</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>正在更新药品: <strong id="refill-medicine-name"></strong></p>
                <div class="mb-3">
                    <label for="refill-total-quantity-input" class="form-label">新的总数量</label>
                    <input type="number" id="refill-total-quantity-input" class="form-control" placeholder="输入当前持有的总数量">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="confirm-refill-btn">确认更新</button>
            </div>
        </div>
    </div>
</div>


<!-- 显示列表 -->
<div class="row mt-4">
    <div class="col-12">
        <!-- **恢复**: "需要购买的药品"卡片 -->
        <div id="needs-purchase-card" class="card border-warning mb-4 d-none">
            <div class="card-header bg-warning">急需购买的药品</div>
            <ul id="needs-purchase-list" class="list-group list-group-flush">
                <!-- 需要购买的药品将在这里动态生成 -->
            </ul>
        </div>
        <div id="medicine-display-area">
            <!-- 按人物分类的药品列表将在这里动态生成 -->
        </div>
    </div>
</div>
{% endblock %}

{% block body_script %}
<script>
    const CATEGORY = 'medicine';

    // 获取并填充人物下拉列表
    async function fetchAndPopulatePeople() {
        const response = await fetch('/api/people');
        const people = await response.json();
        const select = document.getElementById('person-select');
        select.innerHTML = '<option selected disabled>请选择人物...</option>';
        people.forEach(person => {
            const option = document.createElement('option');
            option.value = person.id;
            option.textContent = person.name;
            select.appendChild(option);
        });
    }

    // 添加新药品
    async function addMedicine() {
        const payload = {
            person_id: document.getElementById('person-select').value,
            content: document.getElementById('medicine-content-input').value,
            frequency: document.getElementById('medicine-frequency-input').value,
            dosage: document.getElementById('medicine-dosage-input').value,
            style: document.getElementById('medicine-style-select').value,
            color: document.getElementById('medicine-color-input').value,
            total_quantity: document.getElementById('medicine-total-quantity-input').value,
            refill_quantity: document.getElementById('medicine-refill-quantity-input').value,
            reminder_threshold: document.getElementById('medicine-reminder-threshold-input').value,
            start_date: new Date().toISOString().split('T')[0], // 添加时自动设置为今天
            category: CATEGORY
        };

        // 现在只检查人物和药品名称
        if (!payload.person_id || !payload.content) {
            return alert('请选择人物并填写药品名称！');
        }

        await fetch('/api/records', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        // 清空输入框
        document.getElementById('medicine-content-input').value = '';
        document.getElementById('medicine-frequency-input').value = '';
        document.getElementById('medicine-dosage-input').value = '';
        document.getElementById('medicine-total-quantity-input').value = '';
        document.getElementById('medicine-refill-quantity-input').value = '';
        document.getElementById('medicine-reminder-threshold-input').value = '';
        // 移除对不存在的 start_date 输入框的引用

        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('addMedicineModal'));
        if (modal) {
            modal.hide();
        }

        await fetchAndDisplayMedicines();
    }

    // 更新药品记录
    async function updateMedicine(id) {
        const payload = {
            person_id: document.getElementById('person-select').value,
            content: document.getElementById('medicine-content-input').value,
            frequency: document.getElementById('medicine-frequency-input').value,
            dosage: document.getElementById('medicine-dosage-input').value,
            style: document.getElementById('medicine-style-select').value,
            color: document.getElementById('medicine-color-input').value,
            refill_quantity: document.getElementById('medicine-refill-quantity-input').value,
            reminder_threshold: document.getElementById('medicine-reminder-threshold-input').value,
            // 移除 total_quantity，编辑操作不修改数量
            category: CATEGORY
        };

        if (!payload.person_id || !payload.content) {
            return alert('请选择人物并填写药品名称！');
        }

        await fetch(`/api/records/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const modal = bootstrap.Modal.getInstance(document.getElementById('addMedicineModal'));
        modal.hide();

        await fetchAndDisplayMedicines();
    }

    // 打开药品编辑模态框
    function openEditMedicineModal(item, personId) {
        const modal = new bootstrap.Modal(document.getElementById('addMedicineModal'));
        const modalTitle = document.getElementById('addMedicineModalLabel');
        const confirmButton = document.querySelector('#addMedicineModal .btn-primary');

        modalTitle.textContent = '编辑药品';
        document.getElementById('person-select').value = personId;
        document.getElementById('medicine-content-input').value = item.content;
        document.getElementById('medicine-frequency-input').value = item.frequency || '';
        document.getElementById('medicine-dosage-input').value = item.dosage || '';
        document.getElementById('medicine-style-select').value = item.style || 'circle';
        document.getElementById('medicine-color-input').value = item.color || '#86B7FE';
        document.getElementById('medicine-refill-quantity-input').value = item.refill_quantity || '';
        document.getElementById('medicine-reminder-threshold-input').value = item.reminder_threshold || '';
        
        // 修改：只隐藏“初始总数量”输入框
        document.getElementById('add-total-quantity-row').style.display = 'none';

        confirmButton.textContent = '确认修改';
        confirmButton.onclick = () => updateMedicine(item.id);
        
        modal.show();
    }

    // 重置模态框为“添加”状态
    document.getElementById('addMedicineModal').addEventListener('hidden.bs.modal', event => {
        const modalTitle = document.getElementById('addMedicineModalLabel');
        const confirmButton = document.querySelector('#addMedicineModal .btn-primary');
        
        modalTitle.textContent = '添加药品';
        document.getElementById('medicine-content-input').value = '';
        document.getElementById('medicine-frequency-input').value = '';
        document.getElementById('medicine-dosage-input').value = '';
        document.getElementById('medicine-total-quantity-input').value = '';
        document.getElementById('medicine-refill-quantity-input').value = '';
        document.getElementById('medicine-reminder-threshold-input').value = '';
        
        // 修改：确保“初始总数量”输入框在下次打开“添加”模态框时是可见的
        document.getElementById('add-total-quantity-row').style.display = 'block';
        
        confirmButton.textContent = '确认添加';
        confirmButton.onclick = addMedicine;
    });

    // 新增：打开补充药品模态框
    function openRefillModal(item) {
        const modal = new bootstrap.Modal(document.getElementById('refillMedicineModal'));
        document.getElementById('refill-medicine-name').textContent = item.content;
        const quantityInput = document.getElementById('refill-total-quantity-input');
        quantityInput.value = item.total_quantity || '';
        
        const confirmBtn = document.getElementById('confirm-refill-btn');
        confirmBtn.onclick = () => refillMedicine(item.id);

        modal.show();
    }

    // 新增：执行补充药品操作
    async function refillMedicine(id) {
        const newQuantity = document.getElementById('refill-total-quantity-input').value;
        if (!newQuantity || newQuantity < 0) {
            return alert('请输入有效的药品数量！');
        }

        await fetch(`/api/records/${id}/quantity`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ total_quantity: newQuantity })
        });

        const modal = bootstrap.Modal.getInstance(document.getElementById('refillMedicineModal'));
        modal.hide();
        await fetchAndDisplayMedicines();
    }

    // 获取并按人物分组显示药品
    async function fetchAndDisplayMedicines() {
        const response = await fetch(`/api/records?category=${CATEGORY}`);
        const peopleWithMedicines = await response.json();
        const displayArea = document.getElementById('medicine-display-area');
        displayArea.innerHTML = '';

        // **恢复**: 获取需要购买的列表和卡片元素
        const needsPurchaseList = document.getElementById('needs-purchase-list');
        const needsPurchaseCard = document.getElementById('needs-purchase-card');
        needsPurchaseList.innerHTML = '';
        let needsPurchaseCount = 0;

        if (peopleWithMedicines.length === 0) {
            displayArea.innerHTML = '<p class="text-muted">还没有任何药品记录。</p>';
        }

        peopleWithMedicines.forEach(person => {
            const personCard = document.createElement('div');
            personCard.className = 'card mb-3';
            
            let itemsHtml = '<ul class="list-group list-group-flush">';
            person.items.forEach(item => {
                const shapeHtml = item.style ? `<span class="medicine-shape shape-${item.style}" style="${item.style === 'triangle' ? 'border-bottom-color' : 'background-color'}: ${item.color || '#86B7FE'};"></span>` : '';

                // 构建频率和用量文本
                let detailsText = '未指定用量';
                if (item.frequency && item.dosage) {
                    detailsText = `每天 ${item.frequency} 次 / 每次 ${item.dosage} 片`;
                } else if (item.frequency) {
                    detailsText = `每天 ${item.frequency} 次`;
                } else if (item.dosage) {
                    detailsText = `每次 ${item.dosage} 片`;
                }

                if (typeof item.total_quantity === 'number') {
                    detailsText += ` · 当前库存 ${item.total_quantity} 片`;
                }

                // **恢复**: “加入购买清单”按钮的逻辑
                const purchaseBtnClass = item.needs_purchase ? 'btn-warning' : 'btn-outline-secondary';
                const purchaseBtnText = item.needs_purchase ? '已在清单' : '加入清单';

                itemsHtml += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            ${shapeHtml}
                            <strong>${item.content}</strong>
                            <small class="text-muted d-block">${detailsText}</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-success me-2" onclick='openRefillModal(${JSON.stringify(item)})'>更新数量</button>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick='openEditMedicineModal(${JSON.stringify(item)}, ${person.person_id})'>编辑</button>
                            <!-- **恢复**: “加入购买清单”按钮 -->
                            <button class="btn btn-sm ${purchaseBtnClass} me-2" onclick="toggleNeedsPurchase(${item.id}, ${!item.needs_purchase})">${purchaseBtnText}</button>
                            <a href="#" class="delete-btn" onclick="deleteMedicine(${item.id})">删除</a>
                        </div>
                    </li>
                `;

                // **恢复**: 如果药品库存低于阈值，则在“需要购买”列表中也显示一份
                if (item.total_quantity !== null && item.reminder_threshold !== null && item.total_quantity < item.reminder_threshold) {
                    needsPurchaseCount++;
                    const purchaseLi = document.createElement('li');
                    purchaseLi.className = 'list-group-item d-flex justify-content-between align-items-center';
                    purchaseLi.innerHTML = `
                        <div>
                            <strong>${person.person_name} - ${item.content}</strong>
                            <small class="text-muted d-block">当前库存: ${item.total_quantity}, 阈值: ${item.reminder_threshold}</small>
                        </div>
                        <button class="btn btn-sm ${purchaseBtnClass}" onclick="toggleNeedsPurchase(${item.id}, ${!item.needs_purchase})">${purchaseBtnText}</button>
                    `;
                    needsPurchaseList.appendChild(purchaseLi);
                }
            });
            itemsHtml += '</ul>';

            personCard.innerHTML = `
                <div class="card-header"><h5>${person.person_name}</h5></div>
                ${itemsHtml}
            `;
            displayArea.appendChild(personCard);
        });

        // **恢复**: 根据是否有需要购买的药品，显示或隐藏卡片
        if (needsPurchaseCount > 0) {
            needsPurchaseCard.classList.remove('d-none');
        } else {
            needsPurchaseCard.classList.add('d-none');
        }
    }

    // 删除药品
    async function deleteMedicine(id) {
        if (!confirm('确定要删除这条药品记录吗？')) return;
        await fetch(`/api/records/${id}`, { method: 'DELETE' });
        await fetchAndDisplayMedicines();
    }

    // **恢复**: toggleNeedsPurchase 函数
    async function toggleNeedsPurchase(recordId, needsPurchase) {
        await fetch(`/api/records/${recordId}/purchase`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ needs_purchase: needsPurchase })
        });
        await fetchAndDisplayMedicines();
    }
    
    // **修改**: 页面加载时初始化
    document.addEventListener('DOMContentLoaded', async () => {
        if (['/login', '/register'].includes(window.location.pathname)) return;
        await fetchAndPopulatePeople();
        await fetchAndDisplayMedicines();
    });
</script>
{% endblock %}