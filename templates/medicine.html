{% extends "base.html" %}

{% block title %}药品记录{% endblock %}

{% block head_script %}
<style>
    .medicine-shape {
        display: inline-block;
        width: 24px;
        height: 24px;
        margin-right: 10px;
        vertical-align: middle;
        border: 1px solid rgba(0,0,0,0.1);
        background-color: transparent; /* 默认背景透明 */
    }
    .shape-circle { /* 圆形 */
        border-radius: 50%;
    }
    .shape-oval { /* 椭圆形 */
        width: 28px;
        height: 18px;
        border-radius: 50%;
    }
    .shape-triangle { /* 三角形 */
        width: 0;
        height: 0;
        border-left: 12px solid transparent;
        border-right: 12px solid transparent;
        border-bottom: 22px solid; /* 颜色将通过内联样式设置 */
        border-top: none;
        border-radius: 0;
    }
</style>
{% endblock %}


{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <a href="/" class="btn btn-sm btn-outline-secondary">&lt; 返回主页</a>
    <h1 class="mb-0">药品记录</h1>
    <!-- 触发模态框的按钮 -->
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMedicineModal">
        添加药品
    </button>
</div>

<!-- 添加药品的模态框 -->
<div class="modal fade" id="addMedicineModal" tabindex="-1" aria-labelledby="addMedicineModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMedicineModalLabel">添加药品</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="person-select" class="form-label">所属人物</label>
                    <select id="person-select" class="form-select"></select>
                </div>
                <div class="mb-3">
                    <label for="medicine-content-input" class="form-label">药品名称 <span class="text-danger">*</span></label>
                    <input type="text" id="medicine-content-input" class="form-control" placeholder="例如: 布洛芬">
                </div>
                <div class="row g-2 mb-3">
                    <div class="col">
                        <label for="medicine-frequency-input" class="form-label">用药频率 (选填)</label>
                        <input type="text" id="medicine-frequency-input" class="form-control" placeholder="例如: 每天3次">
                    </div>
                    <div class="col">
                        <label for="medicine-dosage-input" class="form-label">每次用量 (选填)</label>
                        <input type="text" id="medicine-dosage-input" class="form-control" placeholder="例如: 2片">
                    </div>
                </div>
                <div class="row g-2 mb-3">
                    <div class="col">
                        <label for="medicine-style-select" class="form-label">形状 (选填)</label>
                        <select id="medicine-style-select" class="form-select">
                            <option value="circle">圆形</option>
                            <option value="triangle">三角形</option>
                            <option value="oval">椭圆形</option>
                        </select>
                    </div>
                    <div class="col">
                        <label for="medicine-color-input" class="form-label">形状颜色</label>
                        <input type="color" id="medicine-color-input" class="form-control form-control-color" value="#86B7FE" title="选择颜色">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="addMedicine()">确认添加</button>
            </div>
        </div>
    </div>
</div>


<!-- 显示列表 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card mb-3">
            <div class="card-header">需要购买的药品</div>
            <ul id="needs-purchase-list" class="list-group list-group-flush">
                <li class="list-group-item text-muted">暂无需要购买的药品。</li>
            </ul>
        </div>
        <div id="medicine-display-area">
            <!-- 按人物分类的药品列表将在这里动态生成 -->
        </div>
    </div>
</div>
{% endblock %}

{% block body_script %}
<script>
    const CATEGORY = 'medicine';

    // 获取并填充人物下拉列表
    async function fetchAndPopulatePeople() {
        const response = await fetch('/api/people');
        const people = await response.json();
        const select = document.getElementById('person-select');
        select.innerHTML = '<option selected disabled>请选择人物...</option>';
        people.forEach(person => {
            const option = document.createElement('option');
            option.value = person.id;
            option.textContent = person.name;
            select.appendChild(option);
        });
    }

    // 添加新药品
    async function addMedicine() {
        const payload = {
            person_id: document.getElementById('person-select').value,
            content: document.getElementById('medicine-content-input').value,
            frequency: document.getElementById('medicine-frequency-input').value,
            dosage: document.getElementById('medicine-dosage-input').value,
            style: document.getElementById('medicine-style-select').value,
            color: document.getElementById('medicine-color-input').value,
            category: CATEGORY
        };

        // 现在只检查人物和药品名称
        if (!payload.person_id || !payload.content) {
            return alert('请选择人物并填写药品名称！');
        }

        await fetch('/api/records', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        // 清空输入框
        document.getElementById('medicine-content-input').value = '';
        document.getElementById('medicine-frequency-input').value = '';
        document.getElementById('medicine-dosage-input').value = '';

        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('addMedicineModal'));
        if (modal) {
            modal.hide();
        }

        await fetchAndDisplayMedicines();
    }
    

    // 更新药品记录
    async function updateMedicine(id) {
        const payload = {
            person_id: document.getElementById('person-select').value,
            content: document.getElementById('medicine-content-input').value,
            frequency: document.getElementById('medicine-frequency-input').value,
            dosage: document.getElementById('medicine-dosage-input').value,
            style: document.getElementById('medicine-style-select').value,
            color: document.getElementById('medicine-color-input').value,
            category: CATEGORY
        };

        if (!payload.person_id || !payload.content) {
            return alert('请选择人物并填写药品名称！');
        }

        await fetch(`/api/records/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const modal = bootstrap.Modal.getInstance(document.getElementById('addMedicineModal'));
        modal.hide();

        await fetchAndDisplayMedicines();
    }
    
    // 删除记录
    async function deleteMedicine(id) {
        if (!confirm('确定要删除这个药品记录吗？')) return;
        await fetch(`/api/records/${id}`, { method: 'DELETE' });
        await fetchAndDisplayMedicines();
    }

    // 切换购买需求
    async function toggleNeedsPurchase(id, currentState) {
        await fetch(`/api/records/${id}/purchase`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ needs_purchase: !currentState })
        });
        await fetchAndDisplayMedicines();
    }

    // 获取并显示药品
    async function fetchAndDisplayMedicines() {
        const response = await fetch(`/api/records?category=${CATEGORY}`);
        const peopleWithMedicines = await response.json();
        const displayArea = document.getElementById('medicine-display-area');
        const purchaseList = document.getElementById('needs-purchase-list');
        displayArea.innerHTML = '';
        purchaseList.innerHTML = '';
        let needsPurchaseCount = 0;

        if (peopleWithMedicines.length === 0) {
            displayArea.innerHTML = '<p class="text-muted">还没有任何药品记录。</p>';
            purchaseList.innerHTML = '<li class="list-group-item text-muted">暂无需要购买的药品。</li>';
            return;
        }

        peopleWithMedicines.forEach(person => {
            const personCard = document.createElement('div');
            personCard.className = 'card mb-3';
            
            let itemsHtml = '<ul class="list-group list-group-flush">';
            person.items.forEach(item => {
                const style = item.style || 'circle';
                const color = item.color || '#86B7FE';
                // 对三角形特殊处理，因为它使用 border-color 而不是 background-color
                const styleAttr = style === 'triangle' 
                    ? `border-bottom-color: ${color};` 
                    : `background-color: ${color};`;
                const shapeHtml = `<span class="medicine-shape shape-${style}" style="${styleAttr}"></span>`;
                const purchaseBtnText = item.needs_purchase ? '取消购买' : '需要购买';
                const purchaseBtnClass = item.needs_purchase ? 'btn-secondary' : 'btn-warning';

                // 构建频率和用量文本，如果为空则不显示
                let detailsText = [item.frequency, item.dosage].filter(Boolean).join(' / ');
                if (!detailsText) {
                    detailsText = '未指定用量';
                }

                itemsHtml += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            ${shapeHtml}
                            <strong>${item.content}</strong>
                            <small class="text-muted d-block">${detailsText}</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick='openEditMedicineModal(${JSON.stringify(item)}, ${person.person_id})'>编辑</button>
                            <button class="btn btn-sm ${purchaseBtnClass} me-2" onclick="toggleNeedsPurchase(${item.id}, ${item.needs_purchase})">${purchaseBtnText}</button>
                            <a href="#" class="delete-btn" onclick="deleteMedicine(${item.id})">删除</a>
                        </div>
                    </li>
                `;

                if (item.needs_purchase) {
                    needsPurchaseCount++;
                    const purchaseLi = document.createElement('li');
                    purchaseLi.className = 'list-group-item d-flex align-items-center';
                    purchaseLi.innerHTML = `${shapeHtml} <div><strong>${item.content}</strong> <small class="text-muted d-block">(属于: ${person.person_name})</small></div>`;
                    purchaseList.appendChild(purchaseLi);
                }
            });
            itemsHtml += '</ul>';

            personCard.innerHTML = `
                <div class="card-header">
                    <h5>${person.person_name}</h5>
                </div>
                ${itemsHtml}
            `;
            displayArea.appendChild(personCard);
        });

        if (needsPurchaseCount === 0) {
            purchaseList.innerHTML = '<li class="list-group-item text-muted">暂无需要购买的药品。</li>';
        }
    }

    // 页面加载时初始化
    window.onload = async () => {
        await fetchAndPopulatePeople();
        await fetchAndDisplayMedicines();
    };

    // 打开药品编辑模态框
    function openEditMedicineModal(item, personId) {
        const modal = new bootstrap.Modal(document.getElementById('addMedicineModal'));
        const modalTitle = document.getElementById('addMedicineModalLabel');
        const confirmButton = document.querySelector('#addMedicineModal .btn-primary');

        modalTitle.textContent = '编辑药品';
        document.getElementById('person-select').value = personId;
        document.getElementById('medicine-content-input').value = item.content;
        document.getElementById('medicine-frequency-input').value = item.frequency || '';
        document.getElementById('medicine-dosage-input').value = item.dosage || '';
        document.getElementById('medicine-style-select').value = item.style || 'circle';
        document.getElementById('medicine-color-input').value = item.color || '#86B7FE';

        confirmButton.textContent = '确认修改';
        confirmButton.onclick = () => updateMedicine(item.id);
        
        modal.show();
    }

    // 重置模态框为“添加”状态
    document.getElementById('addMedicineModal').addEventListener('hidden.bs.modal', event => {
        const modalTitle = document.getElementById('addMedicineModalLabel');
        const confirmButton = document.querySelector('#addMedicineModal .btn-primary');
        
        modalTitle.textContent = '添加药品';
        document.getElementById('medicine-content-input').value = '';
        document.getElementById('medicine-frequency-input').value = '';
        document.getElementById('medicine-dosage-input').value = '';
        
        confirmButton.textContent = '确认添加';
        confirmButton.onclick = addMedicine;
    });

    // 更新药品记录
    async function updateMedicine(id) {
        const payload = {
            person_id: document.getElementById('person-select').value,
            content: document.getElementById('medicine-content-input').value,
            frequency: document.getElementById('medicine-frequency-input').value,
            dosage: document.getElementById('medicine-dosage-input').value,
            style: document.getElementById('medicine-style-select').value,
            color: document.getElementById('medicine-color-input').value,
            category: CATEGORY
        };

        if (!payload.person_id || !payload.content) {
            return alert('请选择人物并填写药品名称！');
        }

        await fetch(`/api/records/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const modal = bootstrap.Modal.getInstance(document.getElementById('addMedicineModal'));
        modal.hide();

        await fetchAndDisplayMedicines();
    }
</script>
{% endblock %}