{% extends "base.html" %}

{% block title %}äº¤æµç¤¾åŒº{% endblock %}

{% block head_script %}
<style>
    .post-card {
        background-color: #fff;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .post-header {
        display: flex;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #eee;
    }
    .post-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 1rem;
        object-fit: cover;
    }
    .post-author {
        font-weight: bold;
    }
    .post-timestamp {
        font-size: 0.8em;
        color: #888;
    }
    .post-content {
        padding: 1.5rem;
        font-size: 1.1em;
        line-height: 1.6;
        white-space: pre-wrap; /* ä¿æŒæ–‡æœ¬ä¸­çš„æ¢è¡Œ */
    }
    .post-photos {
        padding: 0 1.5rem 1.5rem;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    .post-photos img {
        max-width: 150px;
        max-height: 150px;
        object-fit: cover;
        border-radius: 5px;
        cursor: pointer;
    }
    .post-actions {
        padding: 0.5rem 1.5rem;
        border-top: 1px solid #eee;
        display: flex;
        gap: 1rem;
    }
    .action-btn {
        cursor: pointer;
        color: #555;
        background: none;
        border: none;
        padding: 0.5rem;
        display: flex;
        align-items: center;
    }
    .action-btn:hover {
        color: #0d6efd;
    }
    .action-btn.liked {
        color: #dc3545;
        font-weight: bold;
    }
    .comments-section {
        background-color: #f8f9fa;
        padding: 1rem 1.5rem;
    }
    .comment {
        margin-bottom: 0.75rem;
        font-size: 0.95em;
    }
    .comment-author {
        font-weight: bold;
        margin-right: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <a href="/" class="btn btn-sm btn-outline-secondary">&lt; è¿”å›ä¸»é¡µ</a>
    <h1 class="mb-0">äº¤æµç¤¾åŒº</h1>
    <div></div>
</div>

<!-- å‘å¸ƒæ–°å¸–å­ -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">å‘å¸ƒæ–°åŠ¨æ€</h5>
        <textarea id="new-post-content" class="form-control" rows="3" placeholder="åˆ†äº«æ–°é²œäº‹..."></textarea>
        <div class="mt-2">
            <label for="new-post-photos" class="form-label">æ·»åŠ ç…§ç‰‡</label>
            <input type="file" id="new-post-photos" class="form-control" multiple accept="image/*">
        </div>
        <button class="btn btn-primary mt-2" onclick="createPost()">å‘å¸ƒ</button>
    </div>
</div>

<!-- å¸–å­åˆ—è¡¨ -->
<div id="posts-container">
    <!-- å¸–å­å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
</div>

<!-- ç¼–è¾‘å¸–å­çš„æ¨¡æ€æ¡† -->
<div class="modal fade" id="editPostModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ç¼–è¾‘åŠ¨æ€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-post-id">
                <div class="mb-3">
                    <label for="edit-post-content" class="form-label">å†…å®¹</label>
                    <textarea id="edit-post-content" class="form-control" rows="5"></textarea>
                </div>
                <div class="mb-3">
                    <label for="edit-post-timestamp" class="form-label">å‘å¸ƒæ—¥æœŸ</label>
                    <input type="datetime-local" id="edit-post-timestamp" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary" onclick="savePostChanges()">ä¿å­˜æ›´æ”¹</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_script %}
<script>
    let currentUserId = null;
    let currentUsername = '';

    async function fetchPosts() {
        const response = await fetch('/api/posts');
        const posts = await response.json();
        const container = document.getElementById('posts-container');
        container.innerHTML = '';

        if (posts.length === 0) {
            container.innerHTML = '<p class="text-center text-muted">è¿˜æ²¡æœ‰äººå‘å¸ƒåŠ¨æ€ï¼Œå¿«æ¥æŠ¢å ç¬¬ä¸€ä¸ªå§ï¼</p>';
            return;
        }

        posts.forEach(post => {
            const postEl = document.createElement('div');
            postEl.className = 'post-card';
            postEl.id = `post-${post.id}`;

            const isLiked = post.likes.includes(currentUserId);
            const editBtnHtml = post.is_author ? `<a href="#" class="btn btn-sm btn-outline-secondary ms-auto me-2" onclick='openEditPostModal(${JSON.stringify(post)})'>ç¼–è¾‘</a>` : '';
            const deleteBtnHtml = post.is_author ? `<a href="#" class="delete-btn" onclick="deletePost(${post.id})">åˆ é™¤</a>` : '';

            let photosHtml = '';
            if (post.photos && post.photos.length > 0) {
                photosHtml = `<div class="post-photos">` +
                    post.photos.map(p => `<img src="/${p}" alt="post photo" onclick="showImageModal('/${p}')">`).join('') +
                    `</div>`;
            }

            let commentsHtml = '';
            if (post.comments.length > 0) {
                commentsHtml = post.comments.map(comment => `
                    <div class="comment">
                        <span class="comment-author">${comment.author_username}:</span>
                        <span>${comment.content}</span>
                        ${comment.author_username === currentUsername ? `<a href="#" class="delete-btn ms-2" onclick="deleteComment(${comment.id})">x</a>` : ''}
                    </div>
                `).join('');
            }

            postEl.innerHTML = `
                <div class="post-header">
                    <img src="${post.author_avatar ? '/' + post.author_avatar : 'https://via.placeholder.com/40'}" alt="avatar" class="post-avatar">
                    <div>
                        <div class="post-author">${post.author_username}</div>
                        <div class="post-timestamp">${new Date(post.timestamp).toLocaleString()}</div>
                    </div>
                    ${editBtnHtml}
                    ${deleteBtnHtml}
                </div>
                <div class="post-content">${post.content}</div>
                ${photosHtml}
                <div class="post-actions">
                    <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike(${post.id})">
                        â¤ï¸ <span class="ms-1">${post.likes.length}</span>
                    </button>
                    <button class="action-btn">ğŸ’¬ <span class="ms-1">${post.comments.length}</span></button>
                </div>
                <div class="comments-section">
                    ${commentsHtml}
                    <div class="input-group mt-2">
                        <input type="text" class="form-control form-control-sm" placeholder="æ·»åŠ è¯„è®º..." id="comment-input-${post.id}">
                        <button class="btn btn-sm btn-outline-secondary" onclick="addComment(${post.id})">å‘é€</button>
                    </div>
                </div>
            `;
            container.appendChild(postEl);
        });
    }

    async function createPost() {
        const content = document.getElementById('new-post-content').value;
        const photosInput = document.getElementById('new-post-photos');
        if (!content.trim()) return;

        const formData = new FormData();
        formData.append('content', content);
        for (const file of photosInput.files) {
            formData.append('photos', file);
        }

        await fetch('/api/posts', {
            method: 'POST',
            body: formData
        });

        document.getElementById('new-post-content').value = '';
        photosInput.value = '';
        await fetchPosts();
    }

    async function deletePost(postId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡åŠ¨æ€å—ï¼Ÿæ‰€æœ‰ç›¸å…³çš„è¯„è®ºå’Œç‚¹èµéƒ½ä¼šè¢«åˆ é™¤ã€‚')) return;
        await fetch(`/api/posts/${postId}`, { method: 'DELETE' });
        await fetchPosts();
    }

    async function toggleLike(postId) {
        await fetch(`/api/posts/${postId}/like`, { method: 'POST' });
        await fetchPosts(); // ç®€å•èµ·è§ï¼Œç›´æ¥åˆ·æ–°å…¨éƒ¨å¸–å­
    }

    async function addComment(postId) {
        const input = document.getElementById(`comment-input-${postId}`);
        const content = input.value;
        if (!content.trim()) return;

        await fetch(`/api/posts/${postId}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content })
        });
        input.value = '';
        await fetchPosts();
    }

    async function deleteComment(commentId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) return;
        await fetch(`/api/comments/${commentId}`, { method: 'DELETE' });
        await fetchPosts();
    }

    function openEditPostModal(post) {
        document.getElementById('edit-post-id').value = post.id;
        document.getElementById('edit-post-content').value = post.content;
        // æ ¼å¼åŒ–æ—¥æœŸå’Œæ—¶é—´ä»¥é€‚åº” datetime-local è¾“å…¥æ¡†
        const localDateTime = new Date(new Date(post.timestamp).getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
        document.getElementById('edit-post-timestamp').value = localDateTime;
        const modal = new bootstrap.Modal(document.getElementById('editPostModal'));
        modal.show();
    }

    async function savePostChanges() {
        const postId = document.getElementById('edit-post-id').value;
        const content = document.getElementById('edit-post-content').value;
        const timestamp = document.getElementById('edit-post-timestamp').value;

        const formData = new FormData();
        formData.append('content', content);
        formData.append('timestamp', new Date(timestamp).toISOString());

        await fetch(`/api/posts/${postId}`, {
            method: 'PUT',
            body: formData
        });

        const modal = bootstrap.Modal.getInstance(document.getElementById('editPostModal'));
        modal.hide();
        await fetchPosts();
    }

    document.addEventListener('DOMContentLoaded', async () => {
        if (['/login', '/register'].includes(window.location.pathname)) return;
        
        // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ä»¥åˆ¤æ–­ç‚¹èµçŠ¶æ€å’Œè¯„è®ºä½œè€…
        const userResponse = await fetch('/api/user/current');
        const user = await userResponse.json();
        currentUserId = user.id;
        currentUsername = user.username;

        await fetchPosts();
    });
</script>
{% endblock %}